#! /bin/bash

set -e

SECRET_KEY=$1
SUBDOMAIN=rodas
ACCOUNT_EMAIL="jaime@rodas.mx"

if [ -z "${SECRET_KEY}" ] ; then
	echo "Usage: credentials ACCOUNT_KEY"
	exit 1
fi

echo "Signing into 1P..."
eval $(op signin "$SUBDOMAIN.1password.com" "$ACCOUNT_EMAIL" "$SECRET_KEY")

echo "Making sure ~/.ssh exists..."
mkdir -p ~/.ssh
rm -f ~/.ssh/id_rsa*

printf "Creating id_rsa..."
op get document id_rsa >> ~/.ssh/id_rsa
echo " (success)"

printf "Creating id_rsa.pub..."
op get document id_rsa.pub >> ~/.ssh/id_rsa.pub
echo " (success)"

echo "Setting permissions..."
chmod 600 ~/.ssh/id_rsa*

echo "All done!"
